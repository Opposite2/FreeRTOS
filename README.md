# FreeRTOS小型游戏机项目框架

## 需求

|    名称    |                             功能                             |
| :--------: | :----------------------------------------------------------: |
|   陀螺仪   | 在熄屏状态下，需要且只能通过任一遥控器上的陀螺仪，实现屏幕唤醒功能 |
|   显示屏   | 起始界面：分数排行榜+游戏开始入口+选择游戏关卡（5个，难度需要逐级递增）+当前标准北京时间                                  游戏界面：相关信息——角色的HP、剩余通关时间和游戏道具信息                                                                                          在持续一段时间没有任何操作后，显示屏自动熄屏，但不进入低功耗模式 |
|    音乐    |             在游戏进行的时候必须同时播放背景音乐             |
|   flash    |       每个关卡结束之后，都需要将必要的数据存储到flash        |
|  光敏电阻  |     实时获取周围环境的亮度情况，实现显示屏亮度的自动调节     |
| 旋转编码器 |    实现音量调节，转速越快，音量变化速度也相应地也需要越快    |
|    灯光    |                              无                              |
|    游戏    |     评分机制，合理的胜利/失败条件，两个角色需要有区分度      |
|    密码    | 设置一个开机密码，输入密码时必须显示 *** ，而不是具体数字；密码需要通过无线串口进行修改，禁止使用杜邦线接USB- TTL连接电脑修改 |
|    外设    | 遥控器两个，主机一个，显示屏，音乐，flash，光敏电阻，旋转编码器，灯光 |
| 版本与日志 |    Git，Github，markdown文档（开发日志：bug和解决的过程）    |



## 硬件

|    名称    | 数量 |          实现          |
| :--------: | :--: | :--------------------: |
|   陀螺仪   |  2   |        MPU6050         |
|   遥控器   |  2   |     STM32F103C8T6      |
|    主机    |  1   |     DShanMCU-F103      |
|   显示屏   |  1   |       OLED显示屏       |
|    音乐    |  1   |       无源蜂鸣器       |
|   Flash    |  1   |       Flash模块        |
|  光敏电阻  |  1   |      光敏电阻模块      |
| 旋转编码器 |  1   |     旋转编码器模块     |
|    灯光    |  1   | DShanMCU-F103上的LED灯 |

|            名称            |              接口外设               |   DShanMCU-F103引脚    | STM32F103C8T6引脚 |
| :------------------------: | :---------------------------------: | :--------------------: | :---------------: |
|    MPU6050（0号遥控器）    |               硬件I2C               |           无           |     PB6，PB7      |
|    MPU6050（1号遥控器）    |               硬件I2C               |           无           |     PB6，PB7      |
| STM32F103C8T6（0号遥控器） |              硬件I2C*1              |           无           |    PB10，PB11     |
| STM32F103C8T6（1号遥控器） |              硬件SPI*1              |           无           | PB12，13，14，15  |
|   DShanMCU-F103（主机）    | 硬件I2C*1+DMA\*1，硬件SPI\*1+DMA\*1 | PB10，11与PB13，14，15 |        无         |
|         OLED显示屏         |              硬件I2C*1              |        PB6，PB7        |        无         |
|         无源蜂鸣器         |       硬件TIM*1，输出比较PWM        |          PA8           |        无         |
|         Flash模块          |              硬件SPI*1              |   PA5，PA6，PA7，PB9   |        无         |
|          光敏电阻          |             硬件GPIO*1              |       PA3，PB11        |        无         |
|       旋转编码器模块       |       硬件EXTI*1，硬件DMA\*1        |     PB0，PB1，PB12     |        无         |
|   DShanMCU-F103上的LED灯   |             硬件GPIO*1              |          PC13          |        无         |



## 软件

### 驱动层（RTOS系统层，硬件驱动层，与硬件抽象层）

#### 主机（FreeRTOS）

1. 主机接收任务0，队列0，二进制信号量0，事件组0——优先级0
1. 接收任务——优先级0

   - 触发I2C的DMA_Idle中断
   - 触发I2C_DMA的接收中断与SPI_DMA的接收中断，接收到临时变量0与临时变量1里
   - 如果接收到了数据，那么分别在I2C_DMA接收完成回调函数与SPI_DMA接收完成回调函数里
     - 分别把临时变量0写入队列0，临时变量1写入队列1
     - 分别设置事件组0第1位为1与事件组0第2为为1，表示队列0与队列1读到数据
     - 分别记录下I2C_DMA的接收中断接收完成的时间点与SPI_DMA的接收中断完成的时间点，用于空闲任务的息屏判断
     - 设置事件组0的第0位为1表示亮屏/刷新
   - 如果没有接收到数据，显示屏亮的什么都不做因为有空闲任务会熄屏，显示屏不亮也什么都不做

     读取事件组0的第0位判断是否熄屏（读取之后不改变事件组0的第0位）
2. 空闲任务——优先级最低

     熄屏之后读到数据就亮屏，设置事件组0的第0位
   - 在空闲任务的钩子函数里，首先获取当前时间点

     否则表示亮屏那就读取MPU0650的数据到队列0，长时间没读到就熄屏                                                                                                                                                          
   - 然后判断当前时间点 - 上次息屏时间点是否超过设置的间隔，避免频繁息屏；

   - I2C读取到数据就设置事件组0第1位表示读到数据，否则表示没有读到数据。
     当前时间点 - I2C_DMA的接收完成的时间点是否超过设定的息屏时间

   - 根据事件组第一位判断是否熄屏，熄屏之后读到数据就亮屏
     当前时间点 - SPI_DMA的接收完成的时间点是否超过设定的息屏时间，即设定的息屏时间到了是否还未收到数据，

2. 主机接收任务1，队列1，二进制信号量0，事件组0——优先级0
     如果三个条件都满足逻辑与&&，那么清除事件组0的第0位表示息屏，更新上次息屏的时间点为当前时间点

   - 触发SPI的DMA_Idle中断
3. 显示屏任务——优先级0

     读取事件组0的第0位判断是否熄屏（读取之后不改变事件组0的第0位）
   - 注意：RTOS初始化的时候设置事件组0的第0位为1表示默认亮屏
   - 判断事件组0的第0位：如果为1那么亮屏/刷新，否则为0息屏

     熄屏之后读到数据就亮屏，设置事件组0的第0位

     否则表示亮屏那就读取MPU0650的数据到队列1，长时间没读到就熄屏                                                                                                                                                   

   - SPI读取到数据就设置事件组0第2位表示读到数据，否则表示没有读到数据。

3. 蜂鸣器任务——优先级1
4. 蜂鸣器任务——优先级1

- 播放背景音乐
- 顺时针转EXTI，设置事件组0的第3位，蜂鸣器任务等待事件组的第3位提高音量
- 逆时针转EXTI，设置事件组0的第4位，蜂鸣器任务等待事件组的第4位降低音量

4. Flash任务，队列2——优先级0

   - 关卡结束，从队列2写入Flash，然后清空队列2
   - 起始界面选择存档，先清空队列2，再读取Flash到队列2
5. 光敏电阻任务——优先级2                                                                                                           

5. 光敏电阻任务，事件组——优先级2                                                                                                           
   - 获取事件组0的第0位（读取之后不改变事件组0的第0位），熄屏什么都不做

   - 读取事件组0的第0位（读取之后不改变事件组0的第0位），熄屏什么都不做

     亮屏读取数据，光照越亮电阻越小电压越大调低亮度，光照越暗电阻越大电压越低升高亮度
     如果亮屏读取数据，光照越亮电阻越小电压越大调低亮度，光照越暗电阻越大电压越低升高亮度

6. LED灯任务——优先级1

- 延时输出高低电平实现闪烁
- 游戏结束关闭

7. Flash任务——优先级0

   - 关卡结束，从队列2写入Flash，然后清空队列2
   - 起始界面选择存档，先清空队列2，再读取Flash到队列2

#### 遥控器0（裸机）

1. EXTI与I2C发送中断
   - MPU6050移动的数据触发EXTI，在中断里先执行复杂操作：
   - MPU6050移动触发EXTI：
- 读取MPU6050的数据到临时变量
     - 把临时变量写入环形缓冲区
     - 触发硬件I2C发送中断发送环形缓冲区
     - 用标志位与死循环等待发送完成
     - 触发硬件I2C_DMA发送临时变量

#### 遥控器1（FreeRTOS）

1. EXTI与SPI发送中断
- MPU6050移动的数据触发EXTI，在中断里释放二进制信号量0，不进行复杂操作
- 发送任务
- 获取二进制信号量0，没有就等待
     - 获取到信号量，就读取MPU6050的数据到临时变量
     - 触发硬件SPI发送中断发送临时变量
     - 用二进制信号量1等待发送完成
     - 如果获得信号量，就读取MPU6050的数据到临时变量
     - 触发硬件SPI_DMA发送临时变量

### 应用层

森林冰火人

- 游戏任务，计数型信号量0，软件定时器0，事件组0，队列2——优先级0
  - 默认设置事件组0的第0位，表示亮屏
- 游戏任务——优先级0
- 显示起始界面（脸，排名，存档，新档）
- 显示游戏界面（地图，人物，道具）
- 读取队列0与队列1的数据，分别移动两个角色
- 计数型信号量0计算死亡次数
- 软件定时器0规定游戏时间，两人都到达终点设置事件组0的第5位表示通关，如果时间到了还没通关就不设置事件组0的第5位表示失败
- 游戏结束根据玩家ID，死亡次数计算评分与排名，并且把ID，死亡次数，游戏时间，评分与排名写入队列2

### 问题

1. 怎么实现旋转编码器转速越快，音量变化速度也相应地也需要越快 ？——

每次触发EXTI中断时，记录当前时间戳 `HAL_GetTick()`，并且计算与上次中断的时间差 

转速越快时间差越小 —> 增加音量变化的次数，即提高占空比，反之相反

### 未完待续？？？

- 设置一个开机密码，输入密码时显示 *** ，密码需要通过无线串口进行修改，禁止使用杜邦线接USB- TTL连接电脑修改？

- 通过WIFI模块，每个关卡结束之后，都需要将必要的数据上传到云平台上（如onenet、阿里云、华为云等等）？

- 怎么获取当前标准北京时间？

