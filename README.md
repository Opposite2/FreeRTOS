
## 需求

### 软件

#### 硬件抽象层

|    名称    |                             功能                             |
| :--------: | :----------------------------------------------------------: |
|   陀螺仪   | 在熄屏状态下，需要且只能通过任一遥控器上的陀螺仪，实现屏幕唤醒功能 |
@@ -15,85 +11,104 @@
|  光敏电阻  |     实时获取周围环境的亮度情况，实现显示屏亮度的自动调节     |
| 旋转编码器 |    实现音量调节，转速越快，音量变化速度也相应地也需要越快    |
|    灯光    |                              无                              |
|    游戏    |     评分机制，合理的胜利/失败条件，两个角色需要有区分度      |
|    密码    | 设置一个开机密码，输入密码时必须显示 *** ，而不是具体数字；密码需要通过无线串口进行修改，禁止使用杜邦线接USB- TTL连接电脑修改 |
|    外设    | 遥控器两个，主机一个，显示屏，音乐，flash，光敏电阻，旋转编码器，灯光 |
| 版本与日志 |    Git，Github，markdown文档（开发日志：bug和解决的过程）    |

#### 应用层

- 游戏：评分机制，合理的胜利/失败条件，两个角色需要有区分度

- 密码 ：设置一个开机密码，输入密码时必须显示 *** ，而不是具体数字；
## 硬件

  ​             密码需要通过无线串口进行修改，禁止使用杜邦线接USB- TTL连接到电脑上进行修改
|    名称    | 数量 |          实现          |
| :--------: | :--: | :--------------------: |
|   陀螺仪   |  2   |        MPU6050         |
|   遥控器   |  2   |     STM32F103C8T6      |
|    主机    |  1   |     DShanMCU-F103      |
|   显示屏   |  1   |       OLED显示屏       |
|    音乐    |  1   |       无源蜂鸣器       |
|   Flash    |  1   |       Flash模块        |
|  光敏电阻  |  1   |      光敏电阻模块      |
| 旋转编码器 |  1   |     旋转编码器模块     |
|    灯光    |  1   | DShanMCU-F103上的LED灯 |

### 其他
|            名称            |              接口外设               |        主机引脚        | 从机引脚 |
| :------------------------: | :---------------------------------: | :--------------------: | -------- |
|    MPU6050（0号遥控器）    |               硬件I2C               |                        |          |
|    MPU6050（1号遥控器）    |               硬件I2C               |                        |          |
| STM32F103C8T6（0号遥控器） |              硬件I2C*1              |                        |          |
| STM32F103C8T6（1号遥控器） |              硬件SPI*1              |                        |          |
|   DShanMCU-F103（主机）    | 硬件I2C*1+DMA\*1，硬件SPI\*1+DMA\*1 | PB10，11与PB13，14，15 | 无       |
|         OLED显示屏         |              硬件I2C*1              |        PB6，PB7        | 无       |
|         无源蜂鸣器         |       硬件TIM*1，输出比较PWM        |          PA8           | 无       |
|         Flash模块          |              硬件SPI*1              |   PA5，PA6，PA7，PB9   | 无       |
|          光敏电阻          |             硬件GPIO*1              |       PA3，PB11        | 无       |
|       旋转编码器模块       |       硬件EXTI*1，硬件DMA\*1        |     PB0，PB1，PB12     | 无       |
|   DShanMCU-F103上的LED灯   |             硬件GPIO*1              |          PC13          | 无       |

遥控器两个，主机一个，显示屏，音乐，flash，光敏电阻，旋转编码器，灯光

使用 git 进行版本管理，并将工程（包含开发日志：bug和解决的过程）上传到 github

## 软件

### RTOS层与硬件抽象层

## 实现
1. 主机接收任务0，队列0，二进制信号量0，事件组0——优先级0

### 硬件
   - 触发I2C的DMA_Idle中断

|    外设    | 数量 |            实现             |        引脚        |
| :--------: | :--: | :-------------------------: | :----------------: |
|   遥控器   |  2   | STM32F103C8T6*2，MPU6050\*2 |       ？？？       |
|    主机    |  1   |       DShanMCU-F103*1       |         无         |
|   显示屏   |  1   |         OLED显示屏          |    主机PB6，PB7    |
|    音乐    |  1   |         无源蜂鸣器          |      主机PA8       |
|   Flash    |  1   |          Flash模块          | 主机PA5，PA6，PA7  |
|  光敏电阻  |  1   |        光敏电阻模块         |   主机PA3，PB11    |
| 旋转编码器 |  1   |       旋转编码器模块        | 主机PB0，PB1，PB12 |
|    灯光    |  1   |   STM32F103C8T6上的LED灯    |         无         |
     根据二进制信号量0判断是否熄屏（读取之后不改变二进制信号量0）

### 软件
     熄屏之后读到数据就亮屏，否则表示亮屏那就读取MPU0650的数据到队列0，长时间没读到就熄屏                                                                                                                                                          

#### 硬件抽象层
   - I2C读取到数据就设置事件组0第0位表示读到数据，否则表示没有读到数据。

|    名称    |         实现         |
| :--------: | :------------------: |
|   陀螺仪   |   软件I2C，硬件DMA   |
|   显示屏   |       硬件I2C        |
|   蜂鸣器   | 硬件TIM，输出比较PWM |
|   Flash    |       硬件SPI        |
|  光敏电阻  |       硬件GPIO       |
| 旋转编码器 |  硬件EXTI，硬件DMA   |
|   LED灯    |       硬件GPIO       |
   - 根据事件组第一位判断是否熄屏，熄屏之后读到数据就亮屏

#### RTOS层
2. 主机接收任务1，队列1，二进制信号量0，事件组0——优先级0

1. 陀螺仪任务，队列0，事件组0——优先级0
   - 轮询读取MPU0650的数据                                                                                                                                                   
   -  I2C读取到数据就设置事件组第二位表示读到数据，否则表示没有读到数据。
   - 读到数据就DMA到队列，长时间没读到就熄屏    
   - 根据事件组第一位判断是否熄屏，熄屏之后读到数据就亮屏
2. 默认显示屏任务，事件组0——优先级0
   - 亮屏就设置事件组第一位，否则表示熄屏。
   - 触发SPI的DMA_Idle中断

     根据二进制信号量0判断是否熄屏（读取之后不改变二进制信号量0）

     熄屏之后读到数据就亮屏，否则表示亮屏那就读取MPU0650的数据到队列1，长时间没读到就熄屏                                                                                                                                                       

   - SPI读取到数据就设置事件组0第2位表示读到数据，否则表示没有读到数据。

3. 默认显示屏任务，二进制信号量0——优先级0

   - 亮屏就设置二进制信号量0，否则表示熄屏。
- 显示起始界面
- 显示游戏界面的地图，人物与道具
   - 读取队列0的数据，移动人
3. 蜂鸣器任务——优先级1
   - 读取队列0与队列1的数据，分别移动两个角色

4. 蜂鸣器任务——优先级1

- 播放背景音乐
4. Flash任务，队列1，队列2——优先级0
   - 关卡结束，从队列1写入Flash
   - 起始界面选择存档，读取Flash到队列2
5. 光敏电阻任务，事件组0——优先级2                                                                                                           
   - 如果事件组第一位是1表示熄屏，那么读取数据，光照越亮电阻越小电压越大调低亮度，光照越暗电阻越大电压越低升高亮度
6. 旋转编码器任务，任务通知——优先级2
   -   顺时针转任务通知蜂鸣器任务提高音量，逆时针降低音量
   - 顺时针转EXTI，设置事件组0的第3位，蜂鸣器任务等待事件组的第3位提高音量
   - 逆时针转EXTI，设置事件组0的第4位，蜂鸣器任务等待事件组的第4位降低音量

5. Flash任务，队列2——优先级0

   - 关卡结束，从队列2写入Flash，然后清空队列2
   - 起始界面选择存档，先清空队列2，再读取Flash到队列2

6. 光敏电阻任务，事件组——优先级2                                                                                                           

   - 如果二进制信号量0是1表示熄屏（读取之后不改变二进制信号量0），那么读取数据，光照越亮电阻越小电压越大调低亮度，光照越暗电阻越大电压越低升高亮度

7. LED灯任务——优先级1

- 延时输出高低电平实现闪烁
- 游戏结束关闭

#### 应用层
### 应用层

森林冰火人

- 游戏任务，计数型信号量0，软件定时器0，事件组0，队列1——优先级0
- 游戏任务，计数型信号量0，软件定时器0，事件组0，队列2——优先级0
- 计数型信号量0计算死亡次数
  - 软件定时器0规定游戏时间，两人都到达终点设置事件组0的第3位表示通关，如果时间到了还没通关就不设置事件组0的第3位表示失败
  - 游戏结束根据玩家ID，死亡次数计算评分与排名，并且把ID，死亡次数，游戏时间，评分与排名写入队列1
  - 软件定时器0规定游戏时间，两人都到达终点设置事件组0的第2位表示通关，如果时间到了还没通关就不设置事件组0的第2位表示失败
  - 游戏结束根据玩家ID，死亡次数计算评分与排名，并且把ID，死亡次数，游戏时间，评分与排名写入队列2

### 问题

@@ -103,13 +118,10 @@

转速越快时间差越小 —> 增加音量变化的次数，即提高占空比，反之相反

2. 陀螺仪与MCU之间通过什么通信？——I2C

3. 旋转编码器EXTI与蜂鸣器任务之间用什么通信方式？——任务通知

4. 陀螺仪的通信中断与显示屏任务之间用什么通信方式？——队列
### 待办清单

5. 硬件I2C用完了怎么办？——软件I2C实现，即GPIO模拟 
- [ ] 资源不够用就在优先级低的任务里，写入Flash再读取Flash
- [ ] 遥控器到手立即硬件抽象层（初始化，封装取得）+RTOS层（实时性）

### 未完待续？？？
