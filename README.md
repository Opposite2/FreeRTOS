

# FreeRTOS小型游戏机项目框架

## 需求

|    硬件    |                             功能                             |
| :--------: | :----------------------------------------------------------: |
|   陀螺仪   | 游戏操作与游戏外的操作（选择关卡，选择角色）；                                                                                                                        在熄屏状态下，需要且只能通过任一遥控器上的陀螺仪，实现屏幕唤醒功能 |
|   显示屏   | 起始界面：基本操作说明，分数排行榜与游戏开始入口；                                                                                                              玩家可以任意选择游戏关卡（5个，难度逐级递增）                                                                                                                       游戏界面：角色的HP、剩余通关时间                                                                                                                                              在持续一段时间没有任何操作后，显示屏自动息屏，但不进入低功耗模式 |
|    音乐    |             在游戏进行的时候必须同时播放背景音乐             |
|   flash    |       每个关卡结束之后，都需要将必要的数据存储到flash        |
|    wifi    | 每个关卡结束之后，都需要将必要的数据通过wifi模块上传到云平台上 |
|  光敏电阻  |     实时获取周围环境的亮度情况，实现显示屏亮度的自动调节     |
| 旋转编码器 |        实现音量调节，转速越快音量变化速度也也需要越快        |
|    灯光    |                             提示                             |
|    外设    |                     遥控器两个，主机一个                     |

|    软件    |                          功能                          |
| :--------: | :----------------------------------------------------: |
|    游戏    |  评分机制，合理的胜利/失败条件；两个角色需要有区分度   |
| 版本与日志 | Git，Github，markdown文档（开发日志：bug和解决的过程） |



## 实现

### 硬件

|    名称    | 数量 |          实现          |
| :--------: | :--: | :--------------------: |
|   陀螺仪   |  2   |        MPU6050         |
|   遥控器   |  2   |     STM32F103C8T6      |
|    主机    |  1   |     DShanMCU-F103      |
|   显示屏   |  1   |       OLED显示屏       |
|    音乐    |  1   |       无源蜂鸣器       |
|   Flash    |  1   |       Flash模块        |
|  光敏电阻  |  1   |      光敏电阻模块      |
| 旋转编码器 |  1   |     旋转编码器模块     |
|    灯光    |  1   | DShanMCU-F103上的LED灯 |

|            名称            |                    接口外设                     |    DShanMCU-F103引脚    | STM32F103C8T6引脚 |
| :------------------------: | :---------------------------------------------: | :---------------------: | :---------------: |
|    MPU6050（0号遥控器）    |                     硬件I2C                     |           无            |     PB6，PB7      |
|    MPU6050（1号遥控器）    |                     硬件I2C                     |           无            |     PB6，PB7      |
| STM32F103C8T6（0号遥控器） |                   硬件USART*1                   |           无            |     PA9，PA10     |
| STM32F103C8T6（1号遥控器） |                    硬件SPI*1                    |           无            |   PB13，14，15    |
|   DShanMCU-F103（主机）    | 硬件USART*1+DMA\*1，          硬件SPI\*1+DMA\*1 | PA9，PA10与PB13，14，15 |        无         |
|         OLED显示屏         |                    硬件I2C*1                    |        PB6，PB7         |        无         |
|         无源蜂鸣器         |             硬件TIM*1，输出比较PWM              |           PA8           |        无         |
|         Flash模块          |                    硬件SPI*1                    |   PA5，PA6，PA7，PB9    |        无         |
|          光敏电阻          |                   硬件GPIO*1                    |        PA3，PB11        |        无         |
|       旋转编码器模块       |             硬件EXTI*1，硬件DMA\*1              |     PB0，PB1，PB12      |        无         |
|   DShanMCU-F103上的LED灯   |                   硬件GPIO*1                    |          PC13           |        无         |

### 软件

#### 驱动层

##### 主机（FreeRTOS）

1. 接收任务——优先级0

   - 触发USART_DMA的接收中断与SPI_DMA的接收中断，接收到临时变量0与临时变量1里
   - 如果没有接收到数据，显示屏亮什么都不做因为有空闲任务会息屏，显示屏不亮也什么都不做
   - 如果接收到了数据，那么分别在USART_DMA接收完成回调函数与SPI_DMA接收完成回调函数里
     - 如果处于菜单状态，那么从临时变量读取加速度计，根据x轴加速度移动菜单里的选项选择关卡，根据z轴加速度确定选项
     - 如果处于游戏状态，那么
       - 把临时变量0写入队列0					把临时变量1写入队列1
       - 设置事件组0第1位为1表示队列0读到数据	设置事件组0第2位为1，表示队列1读到数据
     - 最后无论处于什么状态，都要
       - 记录下USART_DMA的接收中断完成的时间点	记录下SPI_DMA的接收中断完成的时间点——用于空闲任务的息屏判断
       - 设置事件组0的第0位为1表示亮屏/刷新	    设置事件组0的第0位为1表示亮屏/刷新

2. 空闲任务——优先级最低

   - 在空闲任务的钩子函数里，首先获取当前时间点

   - 然后判断当前时间点 - 上次息屏时间点是否超过设置的间隔，避免频繁息屏；

     当前时间点 - USART_DMA的接收完成的时间点是否超过设定的息屏时间

     当前时间点 - SPI_DMA的接收完成的时间点是否超过设定的息屏时间，即设定的息屏时间到了是否还未收到数据，

     如果三个条件都满足逻辑与&&，那么清除事件组0的第0位表示息屏，更新上次息屏的时间点为当前时间点

3. 显示屏任务——优先级0

   - 注意：RTOS初始化的时候设置事件组0的第0位为1表示默认亮屏
   - 判断事件组0的第0位：如果为1那么亮屏/刷新，否则为0息屏

4. 蜂鸣器任务——优先级1

   - 在EXTI回调函数里
     - 消抖：获取当前时间点，如果当前时间点 - 上次时间点 < 消抖时间认为是抖动引起直接返回，否则
     - 读取旋转编码器的转速大小与方向（旋转编码器的硬件驱动层函数）
     - 根据转速，更改音量变化幅度
     - 按下按键恢复默认音量，顺时钟提高音量，逆时钟减少音量
   - 在蜂鸣器任务函数里，调用应用层的播放音乐的函数

5. 光敏电阻任务——优先级2                                                                                                           

   - 获取事件组0的第0位（读取之后不改变事件组0的第0位），熄屏什么都不做

     如果亮屏读取数据，光照越亮调低亮度，光照越暗升高亮度

6. LED灯任务——优先级1

   - 延时输出高低电平实现闪烁
   - 无论胜负，等待事件组0的第3位或第4位，关闭灯光

7. Flash任务——优先级0

   - 计数型信号量0与计数型信号量1分别计算玩家0与玩家1的死亡次数

   - 等待事件组1的第2位表示有人胜利了，等待事件组1的第0位或第1位，即先胜利的玩家

     把计算结果写入临时变量，把临时变量写入队列2

   - 等待事件组1的第0位或第1位，后胜利的玩家，把计算结果写入临时变量，把临时变量写入队列3

   - 等待游戏结束，把两个临时变量写入Flash

##### 遥控器0（裸机）

1. EXTI与I2C发送中断
   - MPU6050移动触发EXTI：
     - 读取MPU6050的数据到临时变量
     - 触发硬件USART_DMA发送临时变量

##### 遥控器1（FreeRTOS）

1. EXTI与SPI发送中断
   - MPU6050移动的数据触发EXTI，在中断里释放二进制信号量0，不进行复杂操作
   - 发送任务
     - 获取二进制信号量0，没有就等待
     - 如果获得信号量，就读取MPU6050的数据到临时变量
     - 触发硬件SPI_DMA发送临时变量

#### 应用层

1. 游戏头文件

   - 定义一个游戏结构体，包括
     - 游戏当前状态（起始/菜单/游戏/退出）
     - 菜单当前选择项（数字）
     - 当前关卡（数字）
     - 关卡（关卡结构体）
     - 角色（一个玩家结构体数组，元素个数为2）
     - 游戏开始时间点（配合结束时间点，统计超时时间）
     - 游戏是否结束（是/否）
   - 定义一个枚举类型：游戏状态，因为游戏在同一时间只会处于三个状态中的一个
   - 定义一个关卡结构体：不同的障碍物数量，不同的硬币数量，相同的出口位置
   - 定义一个玩家结构体：x坐标，y坐标，生命值HP，收集的硬币数
   - 定义一个游戏结束数据结构体：id，通关时间，死亡次数，得分

2. 音乐源文件

3. 绘制源文件

4. 游戏源文件

   - 游戏结构体的初始化

   - 更新游戏信息

     - 首先判断是否游戏结束：胜利/失败（超时或全部生命值为零）
     - 否则处理玩家输入
       - 分别获取事件组0的第1位与第2位（获取后清除该位）
       - 如果获取到了，读取队列0与队列1
       - 根据读取的数据，更新游戏结构体里角色的坐标
     - 最后进行关卡与玩家之间的交互，判断是否胜利

   - 关卡与玩家之间的交互

     - 根据游戏结构体里的玩家结构体的坐标，与终点坐标比较判断是否到达终点

     - 如果玩家0到达终点，设置事件组1的第0位。如果玩家1到达终点，设置事件组1的第1位

       任意一个玩家先到达终点，设置事件组1的第2位。当两者都到达终点事件组1的第3位表示胜利

   - 关卡选择

     - 在菜单状态下调用，根据选择的不同关卡，不同地部分初始化游戏结构体

5. 森林冰火人游戏任务

   - 根据游戏当前状态
     - 绘制起始界面
     - 更新/绘制菜单界面
     - 更新游戏信息，绘制游戏界面
     - 更新/绘制结束界面

## 未完待续？？？

- 设置一个开机密码，输入密码时显示 *** ，密码需要通过无线串口进行修改，禁止使用杜邦线接USB- TTL连接电脑修改？

- 通过WIFI模块，每个关卡结束之后，都需要将必要的数据上传到云平台上（如onenet、阿里云、华为云等等）？

- 怎么获取当前标准北京时间？

  
